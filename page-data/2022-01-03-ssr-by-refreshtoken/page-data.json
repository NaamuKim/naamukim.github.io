{
    "componentChunkName": "component---src-templates-post-template-tsx",
    "path": "/2022-01-03-ssr-by-refreshtoken/",
    "result": {"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p>저번에는 accesstoken을 ssr하여 관리하는 방법을 알아보았다. 이번 글에서는 refreshToken을 이용하여 accessToken을 받아오는 일을 서버사이드렌더링 하는 내용을 담고 있다.</p>\n<p>유저의 정보를 서버사이드 렌더링 할 때, 만료되지 않은 액세스 토큰이 있다면, 사용자 정보 요청 후 리덕스에 담아주는 방법으로 문제를 풀었다면 액세스 토큰이 만료됐고 리프레쉬 토큰만 남아있다면 어떻게 사용자 정보를 ssr할 수 있을 지 알아보겠다.</p>\n<p>액세스 토큰과 리프레쉬 토큰을 확인하여 유저 정보를 ssr하는 과정은</p>\n<ol>\n<li>context.req.headers에 쿠키가 있는 지 확인한다.</li>\n<li>액세스 토큰이 있다면 이를 이용해 정보를 불러온다</li>\n<li>액세스 토큰이 없고 리프레쉬 토큰만 있다면 토큰도 재발급 받고, 사용자 정보를 재요청한다.</li>\n<li>받아온 정보들을 리덕스와 cookie에 세팅한다.</li>\n</ol>\n<p>이런식의 코드를 내정보를 사용해야하는 페이지 하단에 넣어두고</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> getServerSideProps <span class=\"token operator\">=</span> wrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getServerSideProps</span><span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">context</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> parsedCookie <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>req\n      <span class=\"token operator\">?</span> cookie<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>cookie <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>req <span class=\"token operator\">&amp;&amp;</span> parsedCookie<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parsedCookie<span class=\"token punctuation\">[</span><span class=\"token string\">\"accessToken\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        context<span class=\"token punctuation\">.</span>store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          type<span class=\"token operator\">:</span> <span class=\"token constant\">LOAD_MY_INFO_REQUEST</span><span class=\"token punctuation\">,</span>\n          data<span class=\"token operator\">:</span> parsedCookie<span class=\"token punctuation\">[</span><span class=\"token string\">\"accessToken\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>parseCookies<span class=\"token punctuation\">[</span><span class=\"token string\">\"refreshToken\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t context<span class=\"token punctuation\">.</span>store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n\t\t\t\t\ttype<span class=\"token operator\">:</span> <span class=\"token constant\">NEW_TOKEN_REQUEST</span><span class=\"token punctuation\">,</span>\n          data<span class=\"token operator\">:</span> parsedCookie<span class=\"token punctuation\">[</span><span class=\"token string\">\"refreshToken\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    context<span class=\"token punctuation\">.</span>store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token constant\">END</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> context<span class=\"token punctuation\">.</span>store<span class=\"token punctuation\">.</span>sagaTask<span class=\"token punctuation\">.</span><span class=\"token function\">toPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>saga 코드들을 살펴보면</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">newTokenAPI</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/auth/refresh-token\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"x-refresh-token\"</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span><span class=\"token operator\">*</span> <span class=\"token function\">refreshToken</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">yield</span> <span class=\"token function\">call</span><span class=\"token punctuation\">(</span>newTokenAPI<span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> accessToken<span class=\"token punctuation\">,</span> refreshToken<span class=\"token punctuation\">,</span> info <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">yield</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span>\n      <span class=\"token function\">newhTokenSuccess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> accessToken<span class=\"token punctuation\">,</span> refreshToken<span class=\"token punctuation\">,</span> info<span class=\"token punctuation\">,</span> setCookie <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cookie<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"accessToken\"</span><span class=\"token punctuation\">,</span> accessToken<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      path<span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cookie<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"refreshToken\"</span><span class=\"token punctuation\">,</span> refreshToken<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      path<span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">yield</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token function\">newTokenFailure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이런 코드를 사용하여 새로운 토큰을 받아오고 처리하면 된다.</p>\n<p>reducer같은 경우엔 refreshToken을 이용하여 새 토큰을 받아오지 못하는 경우(NEW_TOKEN_FAILURE)에 로그아웃을 시켜줘야한다. NEW_TOKEN_SUCCESS에 경우 받아온 나의 정보들을 스토어에 넣어주면 된다.</p>\n<p>두 포스트를 통해 next로 jwt를 ssr하는 방법을 알아보았다.</p>\n<p>jwt를 이용한 방식으로 SSR하는 건 복잡하다. 하지만  브라우저에서 관리하는 토큰으로는 ssr이 안되기 때문에 프론트 서버에 저장된 쿠키를 이용하여 요청을 보낸다고 생각하면</p>\n<p>getServerSideProps에서 토큰을 집어낸다음 서버로 요청할 때 헤더에 토큰을 붙여준다.</p>\n<p>이 개념으로 생각하면 CSR을 한번만 더 풀어내는 방식과 같으므로 CSR과 유사하게 문제를 해결할 수 있다.</p>","frontmatter":{"title":"refreshToken만 있을경우에 유저 정보 Server Side Rendering","summary":"redux와 next사용하여 refreshtoken만 가지고 있는 유저 정보 불러오기","date":"2022.01.03.","categories":["Next.js","Redux"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAXElEQVQoz9WQMQrAIAxFU0IkOCauEcWAQ+5/v0K9gB0q9E1/eTz4AF9wPawBh1jNlBIzE5GqIuKuzMxzTjNrrbn7GCPnvCsjYq01InrvZiYipZQXcQAgooNX/YcbRDgE7S8Pl0gAAAAASUVORK5CYII="},"images":{"fallback":{"src":"/static/283331d58b294ab05c1491be3436600e/6741a/next.png","srcSet":"/static/283331d58b294ab05c1491be3436600e/794b4/next.png 250w,\n/static/283331d58b294ab05c1491be3436600e/d8a16/next.png 500w,\n/static/283331d58b294ab05c1491be3436600e/6741a/next.png 1000w","sizes":"(min-width: 1000px) 1000px, 100vw"},"sources":[{"srcSet":"/static/283331d58b294ab05c1491be3436600e/ef761/next.webp 250w,\n/static/283331d58b294ab05c1491be3436600e/c49b3/next.webp 500w,\n/static/283331d58b294ab05c1491be3436600e/ce7e6/next.webp 1000w","type":"image/webp","sizes":"(min-width: 1000px) 1000px, 100vw"}]},"width":1000,"height":571}},"publicURL":"/static/283331d58b294ab05c1491be3436600e/next.png"}}}}]}},"pageContext":{"slug":"/2022-01-03-ssr-by-refreshtoken/"}},
    "staticQueryHashes": []}