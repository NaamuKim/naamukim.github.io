{
    "componentChunkName": "component---src-templates-post-template-tsx",
    "path": "/2021-12-30-jwtssr-next-redux/",
    "result": {"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p>이 글은 react와 next를 사용한 프로젝트에서 redux를 통해 jwt를 이용하여 사용자 정보를 서버사이드 렌더링 하는 것을 다룬다.</p>\n<p>대게 웹에서 jwt를 다룰 때 로컬스토리지나 세션 스토리지를 사용하곤 한다.</p>\n<p>하지만 ssr을 이용하게 되면 프론트 서버는 로컬스토리지가 없어 사용자의 정보를 가져올 수가 없다.</p>\n<p>그렇기에 나의 경우는 쿠키로부터 토큰을 관리하는 방식을 사용했다.</p>\n<p>토큰을 관리하는 과정을 정리하면</p>\n<ol>\n<li>로그인하면 액세스 토큰과 리프레쉬 토큰을 받는다.</li>\n<li>쿠키와 리덕스에 두 토큰을 넣어놓는다.</li>\n<li>헤더에 액세스 토큰을 붙여놓는다.</li>\n<li>새로고침 시 프론트 서버에 있는 쿠키를 바탕으로 내 정보를 불러온다.</li>\n</ol>\n<p>리덕스 사가를 이용한 로그인 코드이다</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span><span class=\"token operator\">*</span> <span class=\"token function\">logIn</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">yield</span> <span class=\"token function\">call</span><span class=\"token punctuation\">(</span>logInAPI<span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">yield</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      type<span class=\"token operator\">:</span> <span class=\"token constant\">LOG_IN_SUCCESS</span><span class=\"token punctuation\">,</span>\n      data<span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    axios<span class=\"token punctuation\">.</span>defaults<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">[</span><span class=\"token string\">\"x-access-token\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n      result<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>accessToken<span class=\"token punctuation\">;</span>\n  \n    cookie<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"accessToken\"</span><span class=\"token punctuation\">,</span> accessToken<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      path<span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cookie<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"refreshToken\"</span><span class=\"token punctuation\">,</span> refreshToken<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      path<span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">yield</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      type<span class=\"token operator\">:</span> <span class=\"token constant\">LOG_IN_FAILURE</span><span class=\"token punctuation\">,</span>\n      error<span class=\"token operator\">:</span> err<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>코드를 설명하면 로그인 요청이 되면 시작되는 코드인데</p>\n<ol>\n<li>성공 시 데이터를 리덕스 스토어에 넣는다</li>\n<li>앞으로 서버로 정보를 요청할 때 기본적으로 헤더에 access-token이 들어가게끔 한다.</li>\n<li>쿠키에 토큰을 저장한다.</li>\n</ol>\n<p>이걸 이용해서 서버 사이드 렌더링을 하는 코드를 살펴보면</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> getServerSideProps <span class=\"token operator\">=</span> wrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getServerSideProps</span><span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">context</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> parsedCookie <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>req\n      <span class=\"token operator\">?</span> cookie<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>cookie <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>req <span class=\"token operator\">&amp;&amp;</span> parsedCookie<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parsedCookie<span class=\"token punctuation\">[</span><span class=\"token string\">\"accessToken\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        context<span class=\"token punctuation\">.</span>store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          type<span class=\"token operator\">:</span> <span class=\"token constant\">LOAD_MY_INFO_REQUEST</span><span class=\"token punctuation\">,</span>\n          data<span class=\"token operator\">:</span> parsedCookie<span class=\"token punctuation\">[</span><span class=\"token string\">\"accessToken\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    context<span class=\"token punctuation\">.</span>store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token constant\">END</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> context<span class=\"token punctuation\">.</span>store<span class=\"token punctuation\">.</span>sagaTask<span class=\"token punctuation\">.</span><span class=\"token function\">toPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>프론트 서버에 있는 쿠키를 쪼개서 내 정보에 대한 요청을 보내는 코드이다.</p>\n<p>사용자 정보를 요청하는 비동기 코드를 알아보면</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">loadMyInfoAPI</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/auth/me\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"x-access-token\"</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위에 서버사이드 렌더링을 하는 코드에서 쿠키에 있는 토큰을 넣어주면 헤더에 그 토큰을 다시 넣고 정보를 요청한다.</p>\n<p>그리하여 받는 나의 정보를 다시 저장한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span><span class=\"token operator\">*</span> <span class=\"token function\">loadMyInfo</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">yield</span> <span class=\"token function\">call</span><span class=\"token punctuation\">(</span>loadMyInfoAPI<span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">yield</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      type<span class=\"token operator\">:</span> <span class=\"token constant\">LOAD_MY_INFO_SUCCESS</span><span class=\"token punctuation\">,</span>\n      data<span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   \n    cookie<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"accessToken\"</span><span class=\"token punctuation\">,</span> accessToken<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      path<span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cookie<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"refreshToken\"</span><span class=\"token punctuation\">,</span> refreshToken<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      path<span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">yield</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      type<span class=\"token operator\">:</span> <span class=\"token constant\">LOAD_MY_INFO_FAILURE</span><span class=\"token punctuation\">,</span>\n      error<span class=\"token operator\">:</span> err<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이러한 방식을 이용하면 만료가 되지 않는 토큰의 관리를 할 수 있다.</p>\n<p>하지만 리프레쉬 토큰을 이용해서 만료된 액세스 토큰을 바꿔올 수 없는 문제가 있다.</p>\n<p>리프레쉬 토큰을 관리하는 코드와 로그아웃 시 토큰 관리로 다음 포스트를 업로드 하겠다.</p>","frontmatter":{"title":"Next.js에서 redux로 jwt 서버사이드 렌더링하기","summary":"쿠키를 이용하여 토큰을 서버사이드 렌더링하기","date":"2021.12.30.","categories":["Next.js"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAXklEQVQoz83QsQrAIAwE0IiJhIzGNaK4CP7//xUs3W2g0DdluRwcwBfCdh/+F57OlBIzE5GqxhhPw8w85zSz1trYROQ0jIi11rVW793Mcs6llBflAEBE4eHcyT/1j11Z4AT//1/8tAAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/283331d58b294ab05c1491be3436600e/6741a/next.png","srcSet":"/static/283331d58b294ab05c1491be3436600e/794b4/next.png 250w,\n/static/283331d58b294ab05c1491be3436600e/d8a16/next.png 500w,\n/static/283331d58b294ab05c1491be3436600e/6741a/next.png 1000w","sizes":"(min-width: 1000px) 1000px, 100vw"},"sources":[{"srcSet":"/static/283331d58b294ab05c1491be3436600e/ef761/next.webp 250w,\n/static/283331d58b294ab05c1491be3436600e/c49b3/next.webp 500w,\n/static/283331d58b294ab05c1491be3436600e/ce7e6/next.webp 1000w","type":"image/webp","sizes":"(min-width: 1000px) 1000px, 100vw"}]},"width":1000,"height":571}},"publicURL":"/static/283331d58b294ab05c1491be3436600e/next.png"}}}}]}},"pageContext":{"slug":"/2021-12-30-jwtssr-next-redux/"}},
    "staticQueryHashes": []}